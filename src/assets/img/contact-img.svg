n((t,i)=>{i.ctrlKey&&t==115&&((n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.msbDsbUiError)&&(n.TestHookUrlParameters.msbDsbUiError=undefined),this.forceRefresh())}),n.Host.bindKeyDown((n,t)=>{t.ctrlKey&&n==113&&this.forceRefreshFlipper()}),n.Host.bindKeyDown((n,t)=>{t.ctrlKey&&n==114&&this.forceRenderOnlyRefresh()}));u.bindAccountTypesChanged(async()=>{const t=n.AccessTokenManager.getWindowsAccountType();t===0&&await this.setViewModelDynamicSearchBoxContent(null,"DynamicSearchManager.bindAccountTypesChanged");this.flushPendingRefresh()});const f=()=>{this.pendRefresh(3,3)};n.Host.bindAccountChanged(()=>{this.setViewModelDynamicSearchBoxContent(null,"DynamicSearchManager.bindAccountChanged").then(()=>f()).catch(()=>f())})}allowSuspension(){this.resolvePromise&&(this.resolvePromise(),this.resolvePromise=null);n.Host.setIsReloadSuppressedBgTask(!1)}forceRefresh(){if(!n.isDynamicSearchContentPossible()){n.log("Can't force DSB refresh. DSB is not enabled.");return}n.log("DSB: forceBackgroundRefresh");this.pendRefresh(3,5)}forceRefreshFlipper(){n.isDynamicSearchContentPossible()?(n.log("DSB: forceBackgroundRefreshFlipper"),this.pendRefresh(3,6)):n.log("Can't force DSB refresh. DSB is not enabled.")}forceRenderOnlyRefresh(){n.isDynamicSearchContentPossible()?(n.log("DSB: forceRenderOnlyRefresh"),this.pendRefresh(2,5)):n.log("Can't force DSB render-only refresh. DSB is not enabled.")}getSelectableItemsByGroup(){var t,i;if(!n.shouldShowDSBLayout(this.currentQuery))return[];let r=[];return(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isMsbDsbSwitchEnabled())?this.selectDsbViewModels().forEach(n=>{var t;r.push(...(t=n.getSelectableItemsByGroup())!==null&&t!==void 0?t:[])}):r.push(...((i=(t=this.selectDsbViewModel())===null||t===void 0?void 0:t.getSelectableItemsByGroup())!==null&&i!==void 0?i:[])),r}getSelectableItems(){var t,i;if(!n.shouldShowDSBLayout(this.currentQuery))return[];let r=[];return(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isMsbDsbSwitchEnabled())?this.selectDsbViewModels().forEach(n=>{var t;r.push(...(t=n.getSelectableItems())!==null&&t!==void 0?t:[])}):r.push(...((i=(t=this.selectDsbViewModel())===null||t===void 0?void 0:t.getSelectableItems())!==null&&i!==void 0?i:[])),r}async updateDynamicSearchBoxContent(t,i){var f,e;let r="DSBNotPossible",u;n.isDynamicSearchContentPossible()&&((n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isMsbDsbSwitchEnabled())?(n.msbDsbSwitchHost===null||n.msbDsbSwitchHost===void 0?void 0:n.msbDsbSwitchHost.isInBlendedMode())?(u=this._dsbViewModel,r="BlendedMode"):(u=n.config.msbDsbBootstrapForceEnable&&i&&((f=this.previouslySelectedViewModels[0])===null||f===void 0?void 0:f.getName())===i?this.previouslySelectedViewModels[0]:this.selectDsbViewModels()[0],r="NonBlendedMode"):(u=n.config.msbDsbBootstrapForceEnable&&i&&((e=this.previouslySelectedViewModel)===null||e===void 0?void 0:e.getName())===i?this.previouslySelectedViewModel:this.selectDsbViewModel(),r="DsbNormal"));await this.setViewModelDynamicSearchBoxContent(u,t+" updateDynamicSearchBoxContent."+r)}isDSBVisible(){var n,t,i;return((n=this._msb_dsbViewModel)===null||n===void 0?void 0:n.isEnabled())?(t=this._msb_dsbViewModel)===null||t===void 0?void 0:t.getVisibility():(i=this._dsbViewModel)===null||i===void 0?void 0:i.getVisibility()}async trySetDynamicSearchBoxContentWithRetry(t,i,r,f,o,s,h){let v=0,a=!1,c;const l=[];do c=await n.Async.safePromise("setDynamicSearchBoxContentWithResultAsync_url",()=>SearchAppWrapper.CortanaApp.setDynamicSearchBoxContentWithResultAsync(t,i,r,f,o,s,h,!1)),l.push(c),a=!e.includes(c);while(a&&++v<u);c==262144?n.logToMC("Bing_QF_DynamicSearchManager","SkipSettingDynamicContent","logDynamicSearchManager"):c==0?l.length>1&&n.DSBLogWarning("DynamicSearchManager",JSON.stringify({lightGleamValue:i,darkGleamValue:r,results:l,isUrl:s}),new Error("Succeeded to set gleam after failure")):n.DSBLogError("DynamicSearchManager",JSON.stringify({lightGleamValue:i,darkGleamValue:r,results:l,isUrl:s}),new Error("Failed to set gleam"))}async setDynamicSearchBoxContentByJson(t,i,r,u,f,e,o,s,h,c,l,a){var p;let v=h.toISOString();v=v.slice(0,-5)+v.slice(-1);let b={gleamAltText:i!==null&&i!==void 0?i:"",lightGleamUrl:r?u:undefined,darkGleamUrl:r?f:undefined,lightGleamData:r?undefined:u,darkGleamData:r?undefined:f,gleamDimensionEnum:(p=e===null||e===void 0?void 0:e.toString())!==null&&p!==void 0?p:"30x36".toString(),placeholderText:t,expirationTime:v!==null&&v!==void 0?v:"",targetSurface:o?Number(o):undefined,telemetryId:s,showTimeoutInMilliseconds:c,gleamClickEndpoint:l,gleamTooltip:a},w=JSON.stringify(b),y;try{if(y=await n.Async.safePromise("setDynamicContentAsync",()=>SearchAppWrapper.CortanaApp.setDynamicContentAsync(w)),y==262144)n.logToMC("Bing_QF_DynamicSearchManager","SkipSettingDynamicContent","logDynamicSearchManager");else if(y!=0)throw new Error(y.toString());}catch(k){n.DSBLogError("SetDynamicSearchBoxContentResult",`failed to set gleamdata ${k}
 GleamJson:${w}`)}return y}async setDynamicSearchBoxContentUrl(i){let{placeholderText:o,win11ShowForMillis:r,targetSurface:u}=i,{lightGleamDataOrUrl:f,darkGleamDataOrUrl:s,expirationTime:l,gleamSize:h,gleamDimension:a,telemetryId:e,gleamAltText:v,gleamClickEndpoint:y,gleamTooltip:p}=i;r=r!==null&&r!==void 0?r:t;u=u!==null&&u!==void 0?u:0;e||(e=n.getTelemetryIdFromUrl(f));a||(a=n.getGleamDimensionFromGleamSize(h));let c=typeof l=="number"?new Date(l):l;if(n.isDSBSearchApiEnabled())this.setDynamicSearchBoxContentByJson(o,v,!0,f,s,a,u,e,c,r,y,p);else if(n.config.responsiveDynamicSearchAPI)await this.trySetDynamicSearchBoxContentWithRetry(o,f,s,c,h,!0,e);else{if(n.config.targetedDynamicSearchAPI)return n.Async.safePromise("setDynamicContentURLTargeted",()=>SearchAppWrapper.CortanaApp.setDynamicContentURLTargeted(o,f,s,c,h,e,r,u));if(n.config.extendedDynamicSearchAPI)return n.Async.safePromise("setDynamicContentUrl",()=>SearchAppWrapper.CortanaApp.setDynamicContentURL(o,f,s,c,h,e,r));if(SearchAppWrapper.CortanaApp.setDynamicSearchBoxContentURL)return n.Async.safePromise("setDynamicSearchBoxContentUrl",()=>SearchAppWrapper.CortanaApp.setDynamicSearchBoxContentURL(o,f,s,c,h==1));n.log("CortanaApp.setDynamicSearchBoxContent not supported")}}async setDynamicSearchBoxContentRawData(i){let{placeholderText:e,win11ShowForMillis:u,targetSurface:f}=i,{lightGleamDataOrUrl:o,darkGleamDataOrUrl:s,expirationTime:a,gleamSize:h,gleamDimension:c,telemetryId:r,gleamAltText:v,gleamClickEndpoint:y,gleamTooltip:p}=i;u=u!==null&&u!==void 0?u:t;f=f!==null&&f!==void 0?f:0;r=r!==null&&r!==void 0?r:"Not Implemented";c=c!==null&&c!==void 0?c:n.getGleamDimensionFromGleamSize(h);let l=typeof a=="number"?new Date(a):a;if(n.isDSBSearchApiEnabled())this.setDynamicSearchBoxContentByJson(e,v,!1,o,s,c,f,r,l,u,y,p);else if(n.config.responsiveDynamicSearchAPI)await this.trySetDynamicSearchBoxContentWithRetry(e,o,s,l,h,!1,r);else{if(n.config.targetedDynamicSearchAPI)return n.Async.safePromise("setDynamicContentRawDataTargeted",()=>SearchAppWrapper.CortanaApp.setDynamicContentRawDataTargeted(e,o,s,l,h,r,u,f));if(n.config.extendedDynamicSearchAPI)return n.Async.safePromise("setDynamicContentRawData",()=>SearchAppWrapper.CortanaApp.setDynamicContentRawData(e,o,s,l,h,r,u));if(SearchAppWrapper.CortanaApp.setDynamicSearchBoxContentRawData)return n.Async.safePromise("setDynamicSearchBoxContentRawData",()=>SearchAppWrapper.CortanaApp.setDynamicSearchBoxContentRawData(e,o,s,l,h==1));n.log("CortanaApp.setDynamicSearchBoxContentRawData not supported")}}async setSearchAppearanceContent(t){let i,r=t===null||t===void 0?void 0:t.contentType,u=JSON.stringify(t===null||t===void 0?void 0:t.gleamData);try{if(n.isThirdPartyGleamSupported()){r=2;const t=n.Host.get1pSearchApps();if(!t)throw new Error("Unable to get the first party Bing search extension.");i=await n.Async.safePromise("setSearchAppearanceForWebProviderAsync",()=>SearchAppWrapper.CortanaApp.setSearchAppearanceForWebProviderAsync(r,u,t))}else i=await n.Async.safePromise("setSearchAppearanceAsync",()=>SearchAppWrapper.CortanaApp.setSearchAppearanceAsync(r,u));if(i.state==262144)n.logToMC("Bing_QF_DynamicSearchManager","SkipSettingSearchAppearanceContent","logDynamicSearchManager");else if(i.state!=0)throw new Error(JSON.stringify(i));}catch(f){n.DSBLogError("SetSearchAppearanceResult",`failed to set gleamdata ${f}
 GleamJson:${u}`)}}async setSearchAppearanceContentFor3p(t,i){let r,f=t===null||t===void 0?void 0:t.contentType,u=(t===null||t===void 0?void 0:t.gleamData)?JSON.stringify(t.gleamData):"";try{let t=i!==null&&i!==void 0?i:n.Host.getThirdPartyMRUSearhApp();if(!t)throw new Error("3p app extenstion is not provided for 3p SearchAppearance");if(r=await n.Async.safePromise("setSearchAppearanceForWebProviderAsync",()=>SearchAppWrapper.CortanaApp.setSearchAppearanceForWebProviderAsync(f,u,t)),r.state==262144)n.logToMC("Bing_QF_DynamicSearchManager","SkipSettingSearchAppearanceForWebProvider","logDynamicSearchManager");else if(r.state!=0)throw new Error(JSON.stringify(r));}catch(e){n.DSBLogError("SetSearchAppearanceResult",`failed to set gleamdata ${e}
 GleamJson:${u}`)}}setDynamicSearchBoxUpdateInterval(t){return SearchAppWrapper.CortanaApp.updateDynamicSearchBoxUpdateInterval?SearchAppWrapper.CortanaApp.updateDynamicSearchBoxUpdateInterval(t):(n.log("CortanaApp.updateDynamicSearchBoxUpdateInterval not supported"),!1)}hasContent(n){return this.previouslySelectedViewModel?this.previouslySelectedViewModel.hasContent(n):!0}setDsbPanesVisibility(t){var i,r;n.shouldShowDSBLayout(t)?(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isMsbDsbSwitchEnabled())?this.selectDsbViewModels(!0):this.selectDsbViewModel(!0):((i=this._msb_dsbViewModel)===null||i===void 0?void 0:i.setVisibility(!1),(r=this._dsbViewModel)===null||r===void 0?void 0:r.setVisibility(!1))}setDsbVisibility(){var t,i,r,u;((t=this._msb_dsbViewModel)===null||t===void 0?void 0:t.isEnabled())?(this._msb_dsbViewModel.setVisibility(!0),(i=this._dsbViewModel)===null||i===void 0?void 0:i.setVisibility(!!(n.msbDsbSwitchHost===null||n.msbDsbSwitchHost===void 0?void 0:n.msbDsbSwitchHost.isInBlendedMode()),this.appShown)):((r=this._dsbViewModel)===null||r===void 0?void 0:r.setVisibility(!0,this.appShown),(u=this._msb_dsbViewModel)===null||u===void 0?void 0:u.setVisibility(!1))}pendRefresh(t,i){var r;const u=n.AccessTokenManager.getWindowsAccountType();this.logBackgroundTask(`DsbManager_pendRefresh_Start_${t}_reason_${i}`);u!=0?(u!=1||n.isDsbEnabledForEnterprise())&&(n.config.msbDsbMoveIntervalTime?this.refreshViewModel(t,i):(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isMsbDsbSwitchEnabled())?this.selectDsbViewModels(!1,i).forEach(n=>n.refresh(t,i)):(r=this.selectDsbViewModel(!1,i))===null||r===void 0?void 0:r.refresh(t,i)):this.mergePendingRefresh(t,i);this.logBackgroundTask(`DsbManager_pendRefresh_End_${t}_reason_${i}`)}mergePendingRefresh(n,t){if(this.logBackgroundTask("DsbManager_mergePendingRefresh_Start"),this.pendingRefreshParameters){const{strategy:i,reason:r}=this.pendingRefreshParameters;i&1&&(n|=1,t==2&&(t=r));(i&6)==2&&(n=n&-7|2)}this.pendingRefreshParameters={strategy:n,reason:t};this.logBackgroundTask("DsbManager_mergePendingRefresh_End")}flushPendingRefresh(){var t,i;const r=n.AccessTokenManager.getWindowsAccountType();if(r!=0&&this.pendingRefreshParameters){const{strategy:u,reason:r}=this.pendingRefreshParameters;this.pendingRefreshParameters=null;n.config.msbDsbMoveIntervalTime?this.refreshViewModel(u,r):(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isMsbDsbSwitchEnabled())?(t=this.selectDsbViewModels(!1,r))===null||t===void 0?void 0:t.forEach(n=>n.refresh(u,r)):(i=this.selectDsbViewModel(!1,r))===null||i===void 0?void 0:i.refresh(u,r)}}selectDsbViewModels(t,i){var u;let r=[];const f=n.AccessTokenManager.getWindowsAccountType();return f==1||n.config.msbMockToken?((u=this._msb_dsbViewModel)===null||u===void 0?void 0:u.isEnabled())||n.config.msbMockToken?(n.msbDsbSwitchHost===null||n.msbDsbSwitchHost===void 0?void 0:n.msbDsbSwitchHost.isInBlendedMode())?(r.push(this._msb_dsbViewModel),r.push(this._dsbViewModel)):r.push(this._msb_dsbViewModel):n.isConsumerDsbEnabledForEnterprise()&&(n.config.msbDsbBootstrapForceEnable&&i===0&&(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.shouldForceEnterprise())?r.push(this._msb_dsbViewModel):r.push(this._dsbViewModel)):f!=0&&r.push(this._dsbViewModel),this.handleViewModelsChange(r,t),r}handleViewModelsChange(n,t){const i=this.getViewModelMode(n),r=this.getViewModelMode(this.previouslySelectedViewModels);if(i!=r){this.previouslySelectedViewModels=n;this.onViewModelChanged(n[0])}t&&this.setDsbVisibility()}getViewModelMode(n){if(n.length==2)return"Blended";if(n.length==1){if(n[0]==this._msb_dsbViewModel)return"Enterprise";if(n[0]==this._dsbViewModel)return"Consumer"}return"None"}selectDsbViewModel(t,i){var u;let r;const f=n.AccessTokenManager.getWindowsAccountType();return f==1||n.config.msbMockToken?((u=this._msb_dsbViewModel)===null||u===void 0?void 0:u.isEnabled())||n.config.msbMockToken?r=this._msb_dsbViewModel:n.isConsumerDsbEnabledForEnterprise()&&(r=n.config.msbDsbBootstrapForceEnable&&i===0&&(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.shouldForceEnterprise())?this._msb_dsbViewModel:this._dsbViewModel):f!=0&&(r=this._dsbViewModel),this.handleViewModelChange(r,t),r}handleViewModelChange(n,t){if(this.previouslySelectedViewModel!==n){this.previouslySelectedViewModel=n;this.onViewModelChanged(n)}t&&this.setDsbVisibility()}onViewModelChanged(t){this.setDsbVisibility();this.updateDynamicSearchBoxContent(`DynamicSearchManager.onViewModelChanged`,t===null||t===void 0?void 0:t.getName());n.config.msbDsbMoveIntervalTime||this.setViewModelUpdateInterval(t)}onBackgroundTask(){this.pendRefresh(this.appShown?7:3,1)}setViewModelUpdateInterval(n){let t=n===null||n===void 0?void 0:n.getUpdateIntervalMins();this.shouldOverwriteInterval()&&(t=this.remainingTimeToWorkStartHour()+1);let i;t!=null&&(i=this.setDynamicSearchBoxUpdateInterval(t))}refreshViewModel(n,t){const i=this.selectDsbViewModel();this.setViewModelUpdateInterval(i);i===null||i===void 0?void 0:i.refresh(n,t)}remainingTimeToWorkStartHour(){const r=n.getCurrentTime(),u=n.msbDsbHost===null||n.msbDsbHost===void 0?void 0:n.msbDsbHost.getWorkStartHour(),i=n.getCurrentDate(),t=new Date(i);return t.setHours(u,0,0,0),i>t&&t.setDate(i.getDate()+1),Math.floor((t.getTime()-r)/6e4)}shouldOverwriteInterval(){const r=n.msbDsbHost===null||n.msbDsbHost===void 0?void 0:n.msbDsbHost.getWorkStartHour(),u=n.msbDsbHost===null||n.msbDsbHost===void 0?void 0:n.msbDsbHost.getWorkEndHour(),i=n.getCurrentDate(),t=new Date(i);return t.setHours(i.getHours()+n.DEFAULT_DSB_UPDATE_INTERVAL_HOURS),(n.msbDsbHost===null||n.msbDsbHost===void 0?void 0:n.msbDsbHost.isOffWorkHour())&&n.AccessTokenManager.getWindowsAccountType()==1&&t.getHours()>r&&t.getHours()<u}async setViewModelDynamicSearchBoxContent(t,i){var v,u,y,e,o,s,p,h,w,c,b,l,k,a;if(n.config.msbDsbEmptyGleamInvestigation&&(n.msbDsbHost===null||n.msbDsbHost===void 0?void 0:n.msbDsbHost.logGleamSetup("FunctionEntry",t,i)),n.isBingGleamDisabledByRegionalPolicy()){n.config.msbDsbEmptyGleamInvestigation&&(n.msbDsbHost===null||n.msbDsbHost===void 0?void 0:n.msbDsbHost.logGleamSetup("ClearedByRegionalPolicy",t,i+" GleamDisabledByRegionalPolicy"));await((u=(v=SearchAppWrapper.CortanaApp).clearDynamicContent)===null||u===void 0?void 0:u.call(v));await((e=(y=SearchAppWrapper.CortanaApp).removeDynamicSearchBoxContent)===null||e===void 0?void 0:e.call(y));this.previousDynamicSearchBoxContent=undefined;this.previousSearchAppearanceGleamContent=undefined;return}await r.lock();this.logBackgroundTask("DsbManager_setViewModelDynamicSearchBoxContent_Start");try{if(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.disableDSBSearchBoxContent)return;if(n.isSearchPointsOfFlexibilityEnabled()&&(n.AccessTokenManager.getWindowsAccountType()!=1||n.isConsumerDsbEnabledForEnterprise())){const r=(o=t===null||t===void 0?void 0:t.getSearchAppearanceGleamContent)===null||o===void 0?void 0:o.call(t);if(n.isSearchAppearanceGleamTelemetryIdEqual(r,this.previousSearchAppearanceGleamContent))return;if(this.previousSearchAppearanceGleamContent=r,this.previousDynamicSearchBoxContent=undefined,r){let n=r.contentType;n==1?await this.setSearchAppearanceContent(r):n==2&&await this.setSearchAppearanceContentFor3p(r,(s=this.currentQuery)===null||s===void 0?void 0:s.thirdPartySearch)}else this.logBackgroundTask("DsbManager_no_vm_selected"),n.config.msbDsbEmptyGleamInvestigation&&(n.msbDsbHost===null||n.msbDsbHost===void 0?void 0:n.msbDsbHost.logGleamSetup("ClearedByNullContent",t,i+" NoVmSelected")),await((h=(p=SearchAppWrapper.CortanaApp).clearDynamicContent)===null||h===void 0?void 0:h.call(p)),await((c=(w=SearchAppWrapper.CortanaApp).removeDynamicSearchBoxContent)===null||c===void 0?void 0:c.call(w)),this.previousDynamicSearchBoxContent=undefined}else{const r=t===null||t===void 0?void 0:t.getDynamicSearchBoxContent();if(n.areDynamicSearchBoxContentEqual(r,this.previousDynamicSearchBoxContent)){n.config.msbDsbEmptyGleamInvestigation&&(n.msbDsbHost===null||n.msbDsbHost===void 0?void 0:n.msbDsbHost.logGleamSetup("DedupEarlyReturn",t,i+" DynamicSearchBoxContentEqual"));return}if(this.previousDynamicSearchBoxContent=r,this.previousSearchAppearanceGleamContent=undefined,r){const{attributes:n,parameters:t}=r,i=n===null||n===void 0?void 0:n.gleamFormat;switch(i){case 0:await this.setDynamicSearchBoxContentRawData(t);break;case 1:await this.setDynamicSearchBoxContentUrl(t);break;default:await this.setDynamicSearchBoxContentUrl(f)}}else this.logBackgroundTask("DsbManager_no_vm_selected"),n.config.msbDsbEmptyGleamInvestigation&&(n.msbDsbHost===null||n.msbDsbHost===void 0?void 0:n.msbDsbHost.logGleamSetup("ClearedByNullContent",t,i+" NoVmSelected")),await((l=(b=SearchAppWrapper.CortanaApp).clearDynamicContent)===null||l===void 0?void 0:l.call(b)),await((a=(k=SearchAppWrapper.CortanaApp).removeDynamicSearchBoxContent)===null||a===void 0?void 0:a.call(k)),this.previousDynamicSearchBoxContent=undefined}this.logBackgroundTask("DsbManager_setViewModelDynamicSearchBoxContent_End")}finally{r.release()}}getDynamicSearchBoxContentKeyAtShown(){return this.dynamicSearchBoxContentKeyAtShown}getInstrumentedProps(){var i,r;let t=[];return(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isMsbDsbSwitchEnabled())?(t=this.selectDsbViewModels().map(n=>{var t;return(t=n.getInstrumentProps())!==null&&t!==void 0?t:[]}).reduce((n,t)=>n.concat(t),[]),(n.msbDsbSwitchHost===null||n.msbDsbSwitchHost===void 0?void 0:n.msbDsbSwitchHost.shouldShow())&&(t=t.concat(n.msbDsbSwitchHost.getDsbInstrumentProps()))):t=(r=(i=this.selectDsbViewModel())===null||i===void 0?void 0:i.getInstrumentProps())!==null&&r!==void 0?r:[],t}logBackgroundTask(t){n.logToMC("Bing_QF_BackgroundTask_lifecycle",t,"logBackgroundTask")}focus(){var n;if((n=this._dsbViewModel)!==null&&n!==void 0)return n.focus()}}n.DynamicSearchManager=o}(WSB||(WSB={})),function(n){class t{constructor(t){this._page=t;this.pastMomentsContentCache={cacheTime:0,response:null};this.multiMomentsContentCache={cacheTime:0,response:null};this.dismissedMomentsContentCache={};this.DSBV2ContentCache={cacheTime:0,response:null};this.hasPendingGleamUpdate=!1;this.kValueC=n.InstrumentationCommon.KVALUE_DSB_CURRENT_DAY_CONTENT;this.kValueP=n.InstrumentationCommon.KVALUE_DSB_PAST_DAYS_CONTENT;this.kValueV2=n.InstrumentationCommon.KVALUE_DSB_V2_CONTENT;this.kValueM=n.InstrumentationCommon.KVALUE_DSB_MERGED_CONTENT;this.isVisible=!1;this.isDSBMergedCallSuccess=0;this.dwellStartTime=-1;this.dwellEndTime=-1;this.dwellTime=-1;this.DataModelStorageKey=n.config.dsbCacheKey;this.PastMomentsDataModelStorageKey=n.config.dsbFlipperCacheKey;this.DismissedMomentsStorageKey=n.config.dsbDismissCacheKey;this.DSBV2DataModelStorageKey=n.config.dsbV2CacheKey;this.codexStatusCacheKey="userCodexStatus";this.currentUserIDCacheKey="currentDSBUserId";this.serverIG="";this.DSBSearchCallStatusCacheKey="DSBSearchCallStatus";this.DSBSearchCallStatus="None";this.dsbUser=null;this.resetActiveStatus();this.loadDynamicSearchContentFromCache();this.dsbBaseUrl="/DSB";n.config.enableOfflineWithWeb&&n.config.webHost&&n.isBrowserOnline()&&(this.dsbBaseUrl=n.config.webHost+this.dsbBaseUrl);n.Host.bindDismissed(()=>{var t,i;this.renderOnDismissReason!=null&&(this.render(),this.renderOnDismissReason==1&&n.dsbManager.allowSuspension(),this.renderOnDismissReason=null);const r=document===null||document===void 0?void 0:document.activeElement;r&&r.blur();(t=_qs("#dynamic-pane .dsb-moment-content"))===null||t===void 0?void 0:t.classList.add("b_hide");n.shouldShowDSBFullWidth()&&((i=_qs("#dynamic-pane-full .dsbFullWidth"))===null||i===void 0?void 0:i.classList.add("b_hide"))});n.Host.bindShown(()=>{var t,i;(t=_qs("#dynamic-pane .dsb-moment-content"))===null||t===void 0?void 0:t.classList.remove("b_hide");n.shouldShowDSBFullWidth()&&((i=_qs("#dynamic-pane-full .dsbFullWidth"))===null||i===void 0?void 0:i.classList.remove("b_hide"))});n.Host.bindAccountChanged(()=>{var t;if(this.shouldShowBingGleam()){const i=(t=n.Host.getConnectedAccountInfo(0))===null||t===void 0?void 0:t.accountId;if(i){const t=n.LightweightStorage.getItem(this.currentUserIDCacheKey);i!=t&&n.LightweightStorage.setItem(this.currentUserIDCacheKey,i)}}})}getName(){return"DynamicSearchViewModel"}isEnabled(){return!0}getUpdateIntervalMins(){var t;return n.TestHookUrlParameters?(t=n.TestHookUrlParameters.dsbUpdateInterval)!==null&&t!==void 0?t:n.DEFAULT_DSB_UPDATE_INTERVAL_MINS:n.DEFAULT_DSB_UPDATE_INTERVAL_MINS}getDSBGleamExpiryInMins(){var t;return n.TestHookUrlParameters?(t=n.TestHookUrlParameters.dsbGleamExpiryMins)!==null&&t!==void 0?t:n.DEFAULT_DSB_GLEAM_EXPIRY_MINS:n.DEFAULT_DSB_GLEAM_EXPIRY_MINS}getDynamicSearchBoxContent(){return this.dynamicSearchBoxContent}getSearchAppearanceGleamContent(){return this.searchAppearanceGleamContent}resetActiveStatus(){const t=n.getCurrentDateDSB();this.activeMomentsIndexMap={};const i=n.getDateStringInDSBFormat(t);this.activeMomentDate=i;this.currentDateDSBStr=i;this.momentDatesFlipper=n.getDSBMomentDatesForFlipper(t);this.previousMomentDate=this.momentDatesFlipper[this.momentDatesFlipper.length-2];this.nextMomentDate=this.momentDatesFlipper[0]}loadDynamicSearchContentFromCache(){(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.disableDSBCache)||(this.resetInstrumentation(2),n.config.enableDSBMergedRefactor&&this.loadDSBSearchFallbackStatus(),this.loadDismissedMomentsFromCache(),this.loadCurrentDayContentFromCache(),this.loadPastDaysContentFromCache(),n.config.enableDSBMergedRefactor||this.isDSBMergedCallSuccess<0&&n.isDSBFullWidthFlightEnabled()&&this.loadDSBV2ContentFromCache())}loadDSBV2ContentFromCache(){const t=n.LightweightStorage.getItem(this.DSBV2DataModelStorageKey);if(t&&n.isDSBFullWidthFlightEnabled()){this.DSBV2ContentCache=JSON.parse(t);const{cacheTime:i,response:r}=this.DSBV2ContentCache,u=i+this.getDSBGleamExpiryInMins()*n.MINS_TO_MILLIS;n.getCurrentTime()<u&&(this.DSBMiniserpDataModel=this.parseMultiMomentsResponse(r,3),this.DSBMiniserpDataModel||this.instrumentDSBFallback(13,3,null,t))}}loadCurrentDayContentFromCache(){var t,i,r;const u=n.LightweightStorage.getItem(this.DataModelStorageKey);if(u){this.multiMomentsContentCache=JSON.parse(u);const{cacheTime:e,response:c}=this.multiMomentsContentCache;this.gleamDataCacheTime=e;const l=e+this.getDSBGleamExpiryInMins()*n.MINS_TO_MILLIS;if(n.getCurrentTime()<l){let t=n.isDSBV2EnabledMarket()&&this.DSBSearchCallStatus!=="FallbacktoV2"?5:1;this.multiMomentsDataModel=this.parseMultiMomentsResponse(c,t,!0);this.multiMomentsDataModel||this.instrumentDSBFallback(13,t,null,u)}this.resetStatusBasedOnDismissedMoment();const f=(t=this.multiMomentsDataModel)===null||t===void 0?void 0:t.moments[(i=this.activeMomentsIndexMap[this.currentDateDSBStr])!==null&&i!==void 0?i:0];let o=this.getGleamDataFromMoment(f),s=(r=f===null||f===void 0?void 0:f.momentMetadata)===null||r===void 0?void 0:r.MomentType,h=this.getGleamSetReason(f);if(this.shouldShowBingGleam()){let n=this.loadBingGleamFromCache("loadCurrentDayContentFromCache");n&&(o=n,s=undefined,h=4)}n.isSearchPointsOfFlexibilityEnabled()?this.setGleamDataPoFSchema(o,!1,h,s):this.setGleamData(o,e,!1,h,s);this.hasPendingGleamUpdate=!0}}getGleamDataFromMoment(n){var t,i,r,u;let f=(i=(t=n===null||n===void 0?void 0:n.sectionGroups)===null||t===void 0?void 0:t.find(n=>n.cardType==="Hero"))===null||i===void 0?void 0:i.sections;return f?(u=(r=f[0])===null||r===void 0?void 0:r.gleamData)!==null&&u!==void 0?u:null:null}shouldShowBingGleam(){if(!n.config.useCobaltCSS||!n.config.enableCodexGleam||!n.VelocityKeys||!n.isCodexEligible())return!1;const t=n.VelocityKeys.getFeatureStatus(43349158);return t!=="0"?t==="1":n.VelocityKeys.isFeatureEnabled(43572857)}loadPastDaysContentFromCache(){const t=n.LightweightStorage.getItem(this.PastMomentsDataModelStorageKey);if(t){this.pastMomentsContentCache=JSON.parse(t);const{response:n}=this.pastMomentsContentCache;this.isPastMomentsDataExpired()||(this.pastMomentsDataModel=this.parseMultiMomentsResponse(n,2))}}loadDismissedMomentsFromCache(){const t=n.LightweightStorage.getItem(this.DismissedMomentsStorageKey);if(t){this.dismissedMomentsContentCache=JSON.parse(t);let n=!1;const i=this.getValidDismissKeys();for(let t in this.dismissedMomentsContentCache)i.indexOf(t)===-1&&(delete this.dismissedMomentsContentCache[t],n=!0);n&&this.setDismissedMomentsContentToCache(this.dismissedMomentsContentCache)}}setDynamicSearchMultiMomentsContentToCache(t){(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.disableDSBCache)||n.LightweightStorage.setItem(this.DataModelStorageKey,JSON.stringify(t))}setDSBV2MultiMomentsContentToCache(t){(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.disableDSBCache)||n.LightweightStorage.setItem(this.DSBV2DataModelStorageKey,JSON.stringify(t))}setDSBPastMomentsContentToCache(t){(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.disableDSBCache)||n.LightweightStorage.setItem(this.PastMomentsDataModelStorageKey,JSON.stringify(t))}setDismissedMomentsContentToCache(t){(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.disableDSBCache)||n.LightweightStorage.setItem(this.DismissedMomentsStorageKey,JSON.stringify(t))}setBingGleamToCache(t,i){var r,u;if((n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?!void 0:!n.TestHookUrlParameters.disableDSBCache)&&((r=i===null||i===void 0?void 0:i.LightGleamUrl)===null||r===void 0?void 0:r.indexOf("BingChatNavigation"))>-1){let f={user:t,gleam:i,cacheTime:n.getCurrentTime()},r=(u=n.getAccessTokenManager())===null||u===void 0?void 0:u.getSelectedAccountId();r&&(n.LightweightStorage.setItem(this.currentUserIDCacheKey,r),n.LightweightStorage.setItem(this.codexStatusCacheKey+r,JSON.stringify(f)));this.bingGleam=i}}loadBingGleamFromCache(){var i,r,u,f;if(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.disableDSBCache)return undefined;try{if(this.bingGleam)return this.bingGleam;let t=(u=(r=(i=n.getAccessTokenManager())===null||i===void 0?void 0:i.getSelectedAccountId())!==null&&r!==void 0?r:n.LightweightStorage.getItem(this.currentUserIDCacheKey))!==null&&u!==void 0?u:(f=this.dsbUser)===null||f===void 0?void 0:f.Id;if(t){let i=JSON.parse(n.LightweightStorage.getItem(this.codexStatusCacheKey+t));if(i===null||i===void 0?void 0:i.gleam)return this.bingGleam=i.gleam,this.bingGleam}}catch(t){t instanceof Error?n.DSBLogError("loadCodexStatusFromCache",`Name: ${t.name}, message: ${t.message}`,`stackTrace: ${t.stack}`):n.DSBLogError("loadCodexStatusFromCache",`failed to load codex status from cache. ex: ${JSON.stringify(t)}`)}return undefined}async set3pSearchAppearance(t){if(n.isThirdPartyGleamSupported()&&t){const i=this.get3pGleamCache(t);if(i&&i.telemetryId){await this.setGleamDataFromThirdParty(i.gleam,!0);const t=i.cacheTime+n.DEFAULT_3P_GLEAM_CHECK_INTERVAL_MINS*n.MINS_TO_MILLIS;if(n.getCurrentTime()<t)return}this.set3pGleamToCache(t,i===null||i===void 0?void 0:i.gleam);const u=await this.fetch3pGleamSchema(t),r=this.get3pGleamCache(t);(r===null||r===void 0?void 0:r.telemetryId)!==(i===null||i===void 0?void 0:i.telemetryId)&&(u||this.set3pGleamToCache(t,undefined),await this.setGleamDataFromThirdParty(r===null||r===void 0?void 0:r.gleam,!0))}}set3pGleamToCache(t,i){if((n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?!void 0:!n.TestHookUrlParameters.disableDSBCache)&&n.isThirdPartyGleamSupported()&&t){const r=t.applicationUserModelId;let u={telemetryId:i===null||i===void 0?void 0:i.telemetryId,gleam:i,cacheTime:n.getCurrentTime()};n.LightweightStorage.setItem(r,JSON.stringify(u))}}get3pGleamCache(t){if((n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.disableDSBCache)||!n.isThirdPartyGleamSupported()||!t)return undefined;try{let u=t.applicationUserModelId,i=n.LightweightStorage.getItem(u),r;return i&&(r=JSON.parse(i)),r}catch(i){i instanceof Error?n.DSBLogError("load3pGleamFromCache",`Name: ${i.name}, message: ${i.message}`,`stackTrace: ${i.stack}`):n.DSBLogError("load3pGleamFromCache",`failed to load 3p gleam from cache. ex: ${JSON.stringify(i)}`)}return undefined}updateDismissedMomentsContentToCache(n,t){const i=this.createDismissKeyForMoment(n);this.dismissedMomentsContentCache.hasOwnProperty(i)?this.dismissedMomentsContentCache[i].push(t):this.dismissedMomentsContentCache[i]=[t];this.setDismissedMomentsContentToCache(this.dismissedMomentsContentCache)}resetDynamicSearchContent(){this.multiMomentsDataModel=null;this.DSBMiniserpDataModel=null;this.isPastMomentsDataExpired()&&(this.pastMomentsDataModel=null);this.selectableElementGroups=[];this.dynamicSearchBoxContent=null}loadDSBSearchFallbackStatus(){this.DSBSearchCallStatus=n.LightweightStorage.getItem(this.DSBSearchCallStatusCacheKey)}setDSBSearchFallbackStatus(t){n.config.enableDSBMergedRefactor&&(this.DSBSearchCallStatus=t,n.LightweightStorage.setItem(this.DSBSearchCallStatusCacheKey,this.DSBSearchCallStatus))}getInstrumentProps(){return this.instrumentedPropsC&&this.instrumentedPropsP?this.instrumentedPropsC.concat(this.instrumentedPropsP):this.instrumentedPropsC||this.instrumentedPropsP}updateInstrumentProps(n,t){t==2?this.instrumentedPropsP=this.instrumentedPropsP?this.instrumentedPropsP.concat(n):n:this.instrumentedPropsC=this.instrumentedPropsC?this.instrumentedPropsC.concat(n):n}getValidDismissKeys(){return this.momentDatesFlipper.map(n=>this.createDismissKeyForMoment(n))}createDismissKeyForMoment(t){return`${t}-${n.Host.getRegion()}-${n.Host.getLanguage()}`}resetInstrumentation(t){this.kValueC=n.InstrumentationCommon.KVALUE_DSB_CURRENT_DAY_CONTENT;this.kValueV2=n.InstrumentationCommon.KVALUE_DSB_V2_CONTENT;this.kValueM=n.InstrumentationCommon.KVALUE_DSB_MERGED_CONTENT;this.instrumentedPropsC=null;t==2&&(this.kValueP=n.InstrumentationCommon.KVALUE_DSB_PAST_DAYS_CONTENT,this.instrumentedPropsP=null)}getKValue(n){switch(n){case 2:return this.kValueP++;case 3:return this.kValueV2++;case 5:return this.kValueM++;default:return this.kValueC++}}getUrlHandoffType(t){let i=n.tryParseUrl(t,!0);return i?n.isBingHost(i)?0:n.isMsnHost(i)?20:1:0}composeDSBUrlParams(t){n.TestHookUrlParameters&&(t=n.UrlParameters.copyTestParametersTo(t),n.TestHookUrlParameters.dsbBag&&(t=ThresholdUtilities.setUrlParameter(t,"bag",encodeURIComponent(n.TestHookUrlParameters.dsbBag))),n.TestHookUrlParameters.dsbMockDateTimeParam&&(t=ThresholdUtilities.setUrlParameter(t,"dsbMockDateTime",encodeURIComponent(n.TestHookUrlParameters.dsbMockDateTimeParam))),(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.isTest)&&(n.TestHookUrlParameters.dsbBag||(t=ThresholdUtilities.setUrlParameter(t,"bag",encodeURIComponent("VP_WindowsSearchBox.WSB.DSB.dsb_default"))),n.TestHookUrlParameters.dsbMockDateTimeParam||(n.TestHookUrlParameters.dsbMockDateTimeParam="2023-01-10")),n.TestHookUrlParameters.dsbScenario&&(t=ThresholdUtilities.setUrlParameter(t,"dsbScenario",encodeURIComponent(n.TestHookUrlParameters.dsbScenar